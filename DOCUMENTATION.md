# التوثيق الفني - نظام فوترة عدادات الكهرباء

## نظرة عامة

نظام متكامل لإدارة عدادات الكهرباء والفوترة مبني بتقنيات حديثة يوفر واجهة برمجية (REST API) كاملة للربط مع تطبيقات الويب والأندرويد. تم تصميم النظام ليكون قابلاً للتوسع وسهل الصيانة مع دعم كامل للغة العربية.

## المميزات الرئيسية

يوفر النظام مجموعة شاملة من الميزات التي تغطي جميع جوانب إدارة عدادات الكهرباء والفوترة. تشمل هذه الميزات **إدارة العملاء** مع إمكانية تسجيل معلومات كاملة لكل عميل بما في ذلك البيانات الشخصية والعنوان ورقم الهوية الوطنية. كما يدعم النظام **إدارة العدادات** بأنواعها المختلفة (منزلي، تجاري، صناعي) مع تتبع حالة كل عداد وموقعه الجغرافي.

تتضمن الميزات أيضًا **نظام القراءات** الذي يسمح بتسجيل قراءات العدادات بطريقة يدوية أو آلية مع حساب الاستهلاك تلقائيًا. يوفر النظام **إدارة الفواتير** الكاملة مع حساب المبالغ بناءً على التعريفات المحددة والضرائب ورسوم الخدمة. كما يدعم **إدارة المدفوعات** بطرق مختلفة (نقدي، بطاقة، تحويل، محفظة إلكترونية) مع تتبع حالة كل دفعة.

من الميزات المتقدمة **نظام الشكاوى** الذي يتيح للعملاء تقديم شكاوى وطلبات مع إمكانية تتبع حالتها وتعيينها للموظفين المختصين. يوفر النظام أيضًا **نظام الإشعارات** لإرسال تنبيهات للعملاء حول الفواتير الجديدة ومواعيد الدفع. بالإضافة إلى ذلك، يتضمن النظام **سجل النشاطات** الذي يسجل جميع العمليات التي تتم في النظام لأغراض التدقيق والمراجعة.

## البنية التقنية

### التقنيات المستخدمة

| المكون | التقنية | الإصدار |
|--------|---------|---------|
| Backend Framework | Next.js | 15.x |
| Database | MySQL | 8.x |
| ORM | Drizzle ORM | Latest |
| API Layer | tRPC | Latest |
| Frontend | React | 18.x |
| UI Components | shadcn/ui | Latest |
| Styling | Tailwind CSS | 3.x |
| Authentication | JWT | - |
| Language | TypeScript | 5.x |

### هيكل قاعدة البيانات

تتكون قاعدة البيانات من **11 جدول رئيسي** مصممة بعناية لضمان سلامة البيانات والعلاقات بينها. يحتوي جدول **customers** على معلومات العملاء الكاملة بما في ذلك الاسم والهوية الوطنية والهاتف والبريد الإلكتروني والعنوان التفصيلي. يرتبط هذا الجدول بجدول **meters** الذي يحتوي على معلومات العدادات المثبتة لكل عميل.

جدول **readings** يخزن جميع قراءات العدادات مع حساب الاستهلاك تلقائيًا من خلال عمود محسوب (Generated Column). يرتبط هذا الجدول بجدول **invoices** الذي يحتوي على الفواتير المصدرة بناءً على القراءات. جدول **payments** يسجل جميع المدفوعات المستلمة ويرتبط بالفواتير لتحديث حالتها تلقائيًا.

جدول **tariffs** يحتوي على تعريفات أسعار الكهرباء بناءً على نوع العداد والشرائح الاستهلاكية. جدول **employees** يخزن معلومات موظفي النظام مع أدوارهم وصلاحياتهم. جدول **notifications** يحتوي على الإشعارات المرسلة للعملاء، بينما جدول **complaints** يخزن الشكاوى والطلبات. أخيرًا، جدول **activityLogs** يسجل جميع العمليات في النظام لأغراض التدقيق.

### العلاقات بين الجداول

تم تصميم العلاقات بين الجداول بطريقة تضمن سلامة البيانات المرجعية (Referential Integrity). توجد علاقة **واحد إلى متعدد** (One-to-Many) بين العملاء والعدادات، حيث يمكن للعميل الواحد أن يمتلك عدة عدادات. كل عداد يرتبط بقراءات متعددة عبر علاقة واحد إلى متعدد أيضًا.

الفواتير ترتبط بالعملاء والعدادات والقراءات من خلال مفاتيح أجنبية (Foreign Keys). كل فاتورة يمكن أن يكون لها دفعات متعددة، مما يسمح بالدفع على أقساط. الشكاوى ترتبط بالعملاء والعدادات والموظفين المكلفين بمعالجتها. جميع هذه العلاقات محمية بقيود قاعدة البيانات لضمان عدم حذف بيانات مرتبطة بشكل غير صحيح.

## الواجهة البرمجية (API)

### نقاط API الرئيسية

يوفر النظام **7 routers رئيسية** تغطي جميع العمليات المطلوبة. كل router يحتوي على مجموعة من الإجراءات (Procedures) التي تنفذ عمليات CRUD (إنشاء، قراءة، تحديث، حذف) على الكيانات المختلفة.

#### 1. Customers Router

يوفر هذا Router العمليات التالية:

- **getAll**: الحصول على جميع العملاء
- **getById**: الحصول على عميل محدد بالمعرف
- **search**: البحث عن العملاء بالاسم أو رقم الهاتف أو رقم الهوية
- **create**: إنشاء عميل جديد
- **update**: تحديث بيانات عميل موجود
- **delete**: حذف عميل

#### 2. Meters Router

يوفر العمليات التالية:

- **getAll**: الحصول على جميع العدادات
- **getById**: الحصول على عداد محدد
- **getByCustomerId**: الحصول على جميع عدادات عميل معين
- **create**: إنشاء عداد جديد
- **update**: تحديث بيانات عداد
- **delete**: حذف عداد

#### 3. Readings Router

يوفر العمليات التالية:

- **getAll**: الحصول على جميع القراءات
- **getById**: الحصول على قراءة محددة
- **getByMeterId**: الحصول على جميع قراءات عداد معين
- **create**: إنشاء قراءة جديدة
- **update**: تحديث قراءة موجودة

#### 4. Invoices Router

يوفر العمليات التالية:

- **getAll**: الحصول على جميع الفواتير
- **getById**: الحصول على فاتورة محددة
- **getByCustomerId**: الحصول على جميع فواتير عميل معين
- **create**: إنشاء فاتورة جديدة
- **update**: تحديث فاتورة موجودة
- **delete**: حذف فاتورة

#### 5. Payments Router

يوفر العمليات التالية:

- **getAll**: الحصول على جميع المدفوعات
- **getById**: الحصول على دفعة محددة
- **getByInvoiceId**: الحصول على جميع دفعات فاتورة معينة
- **create**: إنشاء دفعة جديدة (يقوم تلقائيًا بتحديث حالة الفاتورة)

#### 6. Complaints Router

يوفر العمليات التالية:

- **getAll**: الحصول على جميع الشكاوى
- **getById**: الحصول على شكوى محددة
- **getByCustomerId**: الحصول على جميع شكاوى عميل معين
- **create**: إنشاء شكوى جديدة
- **update**: تحديث شكوى موجودة

#### 7. Notifications Router

يوفر العمليات التالية:

- **getByCustomerId**: الحصول على جميع إشعارات عميل معين
- **create**: إنشاء إشعار جديد
- **markAsRead**: تعليم إشعار كمقروء

### أمثلة على استخدام API

#### مثال 1: إنشاء عميل جديد

```typescript
const newCustomer = await trpc.customers.create.mutate({
  fullName: "أحمد محمد السعيد",
  nationalId: "1234567890",
  phone: "0551234567",
  email: "ahmed@email.com",
  address: "شارع الملك فهد، حي النزهة",
  city: "الرياض",
  district: "النزهة",
  registrationDate: "2024-01-15",
  status: "نشط"
});
```

#### مثال 2: الحصول على جميع عدادات عميل

```typescript
const meters = await trpc.meters.getByCustomerId.query({
  customerId: 1
});
```

#### مثال 3: إنشاء قراءة جديدة

```typescript
const newReading = await trpc.readings.create.mutate({
  meterId: 1,
  readingDate: "2024-09-01T10:00:00",
  previousReading: 10000,
  currentReading: 10850,
  consumption: 850,
  readerId: 2,
  readingMethod: "يدوي"
});
```

#### مثال 4: إنشاء فاتورة

```typescript
const newInvoice = await trpc.invoices.create.mutate({
  invoiceNumber: "INV-2024-09-0001",
  customerId: 1,
  meterId: 1,
  readingId: 1,
  billingPeriodStart: "2024-08-01",
  billingPeriodEnd: "2024-08-31",
  consumption: 850,
  unitPrice: 0.18,
  subtotal: 153.00,
  taxAmount: 22.95,
  serviceFees: 10.00,
  totalAmount: 185.95,
  dueDate: "2024-09-15",
  status: "معلقة"
});
```

#### مثال 5: تسجيل دفعة

```typescript
const newPayment = await trpc.payments.create.mutate({
  invoiceId: 1,
  customerId: 1,
  paymentDate: "2024-09-10T14:30:00",
  amount: 185.95,
  paymentMethod: "بطاقة",
  transactionReference: "TXN-20240910-001",
  paymentStatus: "مكتمل",
  receivedBy: 3
});
```

## لوحة التحكم

### الصفحة الرئيسية

تعرض الصفحة الرئيسية **6 بطاقات إحصائية** رئيسية تعطي نظرة سريعة على حالة النظام. تشمل هذه البطاقات إجمالي العملاء المسجلين، عدد العدادات النشطة، عدد الفواتير المعلقة، إجمالي المدفوعات المحصلة، عدد الشكاوى الجديدة، وإجمالي العدادات في النظام. كل بطاقة مصممة بألوان مميزة وأيقونات واضحة لسهولة التعرف عليها.

بالإضافة إلى البطاقات الإحصائية، تعرض الصفحة الرئيسية **قسمين للنشاطات الأخيرة**. القسم الأول يعرض آخر 5 فواتير في النظام مع تفاصيل كل فاتورة بما في ذلك رقم الفاتورة والمبلغ والحالة. القسم الثاني يعرض آخر 5 شكاوى مع عنوان كل شكوى ونوعها وحالتها. هذه الأقسام تساعد المستخدمين على متابعة آخر التطورات في النظام بسرعة.

في أسفل الصفحة، يوجد **قسم الإجراءات السريعة** الذي يوفر روابط سريعة للوصول إلى الأقسام الرئيسية في النظام. تشمل هذه الروابط إدارة العملاء، إدارة العدادات، إدارة الفواتير، وإدارة الشكاوى. كل رابط مصمم كبطاقة ملونة مع أيقونة مميزة لسهولة التعرف عليه.

### صفحة إدارة العملاء

توفر هذه الصفحة **واجهة شاملة لإدارة العملاء** مع إمكانية البحث والتصفية. في أعلى الصفحة، يوجد شريط بحث يسمح بالبحث عن العملاء بالاسم أو رقم الهاتف أو رقم الهوية الوطنية. البحث يتم بشكل فوري أثناء الكتابة دون الحاجة للضغط على زر.

تعرض الصفحة جدولاً يحتوي على جميع العملاء مع معلوماتهم الأساسية. يتضمن الجدول الأعمدة التالية: الرقم التسلسلي، الاسم الكامل، رقم الهوية، رقم الهاتف، المدينة، والحالة. كل صف في الجدول يحتوي على **ثلاثة أزرار للإجراءات**: عرض التفاصيل، تعديل البيانات، وحذف العميل. عند محاولة حذف عميل، يظهر تأكيد للتأكد من رغبة المستخدم في الحذف.

## التثبيت والإعداد

### المتطلبات الأساسية

قبل البدء في تثبيت النظام، يجب التأكد من توفر المتطلبات التالية على الجهاز:

| المتطلب | الإصدار المطلوب |
|---------|-----------------|
| Node.js | 18.x أو أحدث |
| pnpm | 8.x أو أحدث |
| MySQL | 8.x أو أحدث |
| Git | أي إصدار حديث |

### خطوات التثبيت

#### 1. استنساخ المشروع

```bash
git clone <repository-url>
cd electricity-billing-api
```

#### 2. تثبيت الحزم

```bash
pnpm install
```

#### 3. إعداد قاعدة البيانات

قم بإنشاء ملف `.env` في جذر المشروع وأضف المتغيرات التالية:

```env
DATABASE_URL=mysql://username:password@localhost:3306/electricity_billing
JWT_SECRET=your-secret-key-here
```

استبدل `username` و `password` ببيانات اتصال MySQL الخاصة بك.

#### 4. تطبيق الهجرات (Migrations)

```bash
pnpm db:push
```

هذا الأمر سيقوم بإنشاء جميع الجداول والعلاقات في قاعدة البيانات.

#### 5. إدراج البيانات التجريبية (اختياري)

```bash
npx tsx scripts/seed-data.ts
```

هذا الأمر سيقوم بإدراج بيانات تجريبية في قاعدة البيانات لاختبار النظام.

#### 6. تشغيل الخادم

```bash
pnpm dev
```

سيتم تشغيل الخادم على المنفذ 3000 افتراضيًا. يمكنك الوصول إلى النظام عبر المتصفح على العنوان: `http://localhost:3000`

## الاستخدام مع تطبيقات الأندرويد

### إعداد العميل

لاستخدام API مع تطبيق أندرويد، يمكنك استخدام مكتبة **Retrofit** أو **OkHttp** للاتصال بنقاط API. إليك مثال على إعداد Retrofit:

```kotlin
// build.gradle
dependencies {
    implementation 'com.squareup.retrofit2:retrofit:2.9.0'
    implementation 'com.squareup.retrofit2:converter-gson:2.9.0'
}

// ApiService.kt
interface ApiService {
    @GET("api/trpc/customers.getAll")
    suspend fun getAllCustomers(): Response<CustomersResponse>
    
    @POST("api/trpc/customers.create")
    suspend fun createCustomer(@Body customer: Customer): Response<Customer>
}

// RetrofitClient.kt
object RetrofitClient {
    private const val BASE_URL = "https://your-domain.com/"
    
    val apiService: ApiService by lazy {
        Retrofit.Builder()
            .baseUrl(BASE_URL)
            .addConverterFactory(GsonConverterFactory.create())
            .build()
            .create(ApiService::class.java)
    }
}
```

### مثال على الاستخدام

```kotlin
// في ViewModel أو Repository
class CustomerRepository {
    suspend fun getAllCustomers(): List<Customer> {
        val response = RetrofitClient.apiService.getAllCustomers()
        if (response.isSuccessful) {
            return response.body()?.result?.data ?: emptyList()
        }
        throw Exception("Failed to fetch customers")
    }
    
    suspend fun createCustomer(customer: Customer): Customer {
        val response = RetrofitClient.apiService.createCustomer(customer)
        if (response.isSuccessful) {
            return response.body() ?: throw Exception("Empty response")
        }
        throw Exception("Failed to create customer")
    }
}
```

## الأمان

### المصادقة والتفويض

يستخدم النظام **JWT (JSON Web Tokens)** للمصادقة والتفويض. عند تسجيل الدخول بنجاح، يتم إصدار token يحتوي على معلومات المستخدم وصلاحياته. يجب إرسال هذا Token في رأس كل طلب API:

```
Authorization: Bearer <token>
```

### تشفير كلمات المرور

يتم تشفير جميع كلمات المرور باستخدام **bcrypt** مع salt factor يبلغ 10. هذا يضمن أن كلمات المرور لا يمكن فك تشفيرها حتى في حالة اختراق قاعدة البيانات.

### حماية من هجمات SQL Injection

يستخدم النظام **Drizzle ORM** الذي يوفر حماية تلقائية من هجمات SQL Injection من خلال استخدام Prepared Statements. جميع الاستعلامات يتم تنفيذها بطريقة آمنة دون الحاجة لتنظيف المدخلات يدويًا.

### سجل النشاطات

يحتفظ النظام بسجل كامل لجميع العمليات التي تتم في قاعدة البيانات. يتضمن السجل معلومات عن المستخدم الذي قام بالعملية، نوع العملية، الجدول المتأثر، ومعرف السجل المتأثر. هذا السجل مفيد للتدقيق والمراجعة والتحقيق في أي مشاكل أمنية.

## الصيانة والتطوير

### إضافة جداول جديدة

لإضافة جدول جديد إلى قاعدة البيانات:

1. أضف تعريف الجدول في ملف `drizzle/schema.ts`
2. أنشئ الدوال المطلوبة في ملف `server/db.ts`
3. أنشئ Router جديد في مجلد `server/routers/`
4. أضف Router إلى `server/routers.ts`
5. نفذ الهجرة باستخدام `pnpm db:push`

### إضافة صفحات جديدة

لإضافة صفحة جديدة إلى لوحة التحكم:

1. أنشئ ملف الصفحة في `client/src/pages/`
2. أضف المسار في `client/src/App.tsx`
3. استخدم مكونات shadcn/ui للحفاظ على التصميم المتسق

### اختبار API

يمكنك اختبار نقاط API باستخدام أدوات مثل **Postman** أو **Thunder Client**. جميع نقاط API تتبع بنية tRPC القياسية:

```
POST /api/trpc/[router].[procedure]
```

على سبيل المثال:
- `POST /api/trpc/customers.getAll` - للحصول على جميع العملاء
- `POST /api/trpc/customers.create` - لإنشاء عميل جديد

## الخلاصة

يوفر نظام فوترة عدادات الكهرباء حلاً متكاملاً وحديثًا لإدارة العدادات والفوترة. تم بناء النظام باستخدام أحدث التقنيات والممارسات لضمان الأداء العالي والأمان والقابلية للتوسع. يمكن استخدام النظام مباشرة عبر لوحة التحكم الويب أو الربط مع تطبيقات الأندرويد من خلال الواجهة البرمجية الشاملة.

---

**تم إنشاء هذا التوثيق بواسطة:** Manus AI  
**تاريخ الإصدار:** 28 أكتوبر 2024  
**الإصدار:** 1.0.0
